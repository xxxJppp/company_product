var faces=function(n){return"img/face/"+"[\u5fae\u7b11] [\u563b\u563b] [\u54c8\u54c8] [\u53ef\u7231] [\u53ef\u601c] [\u6316\u9f3b] [\u5403\u60ca] [\u5bb3\u7f9e] [\u6324\u773c] [\u95ed\u5634] [\u9119\u89c6] [\u7231\u4f60] [\u6cea] [\u5077\u7b11] [\u4eb2\u4eb2] [\u751f\u75c5] [\u592a\u5f00\u5fc3] [\u767d\u773c] [\u53f3\u54fc\u54fc] [\u5de6\u54fc\u54fc] [\u5618] [\u8870] [\u59d4\u5c48] [\u5410] [\u54c8\u6b20] [\u62b1\u62b1] [\u6012] [\u7591\u95ee] [\u998b\u5634] [\u62dc\u62dc] [\u601d\u8003] [\u6c57] [\u56f0] [\u7761] [\u94b1] [\u5931\u671b] [\u9177] [\u8272] [\u54fc] [\u9f13\u638c] [\u6655] [\u60b2\u4f24] [\u6293\u72c2] [\u9ed1\u7ebf] [\u9634\u9669] [\u6012\u9a82] [\u4e92\u7c89] [\u5fc3] [\u4f24\u5fc3] [\u732a\u5934] [\u718a\u732b] [\u5154\u5b50] [ok] [\u8036] [good] [NO] [\u8d5e] [\u6765] [\u5f31] [\u8349\u6ce5\u9a6c] [\u795e\u9a6c] [\u56e7] [\u6d6e\u4e91] [\u7ed9\u529b] [\u56f4\u89c2] [\u5a01\u6b66] [\u5965\u7279\u66fc] [\u793c\u7269] [\u949f] [\u8bdd\u7b52] [\u8721\u70db] [\u86cb\u7cd5]".split(" ").indexOf(n)+".gif"},textChange=function(n){var q=function(e){return new RegExp("\\n*\\["+(e||"")+"(code|pre|div|span|p|table|thead|th|tbody|tr|td|ul|li|ol|li|dl|dt|dd|h2|h3|h4|h5)([\\s\\S]*?)\\]\\n*","g")};return(n||"").replace(/&(?!#?[a-zA-Z0-9]+;)/g,"\x26amp;").replace(/</g,"\x26lt;").replace(/>/g,"\x26gt;").replace(/'/g,"\x26#39;").replace(/"/g,"\x26quot;").replace(/@(\S+)(\s+?|$)/g,'@\x3ca href\x3d"javascript:;"\x3e$1\x3c/a\x3e$2').replace(/face\[([^\s\[\]]+?)\]/g,function(e){e=e.replace(/^face/g,"");return'\x3cimg alt\x3d"'+e+'" title\x3d"'+e+'" src\x3d"'+faces(e)+'"\x3e'}).replace(/img\[([^\s]+?)\]/g,function(e){e=e.replace(/(^img\[)|(\]$)/g,"");return'\x3cimg class\x3d"layui-layim-photos" src\x3d"'+e+'" layer-src\x3d"'+e+'"\x3e'}).replace(/a\([\s\S]+?\)\[[\s\S]*?\]/g,function(e){var h=(e.match(/a\(([\s\S]+?)\)\[/)||[])[1],k=(e.match(/\)\[([\s\S]*?)\]/)||[])[1];return h?'\x3ca href\x3d"'+h+'" target\x3d"_blank"\x3e'+(k||h)+"\x3c/a\x3e":e}).replace(q(),"\x3c$1 $2\x3e").replace(q("/"),"\x3c/$1\x3e").replace(/\n/g,"\x3cbr\x3e")};layui.use("layer",function(){function n(a){m.xmlInput=function(a){$.nodeName(a,"iq")&&1==$(a).children().length&&$.nodeName($(a).children().eq(0)[0],"body")&&"lottery"==$(a).children().eq(0)[0].getAttribute("xmlns")&&(a=JSON.parse($(a).children().eq(0).text()),1==a.type?(p=a,null===k&&(k=new g(window),k.createTemplte(p.list))):2==a.type&&k.changeStatus(a))};a==Strophe.Status.ERROR?console.log("\u51fa\u73b0\u9519\u8bef"):a==Strophe.Status.CONNECTING?console.log("\u6b63\u5728\u94fe\u63a5"):a==Strophe.Status.CONNFAIL?console.log("\u8fde\u63a5\u5c1d\u8bd5\u5931\u8d25"):a==Strophe.Status.DISCONNECTING?console.log("\u5f53\u524d\u6b63\u5728\u7ec8\u6b62\u8fde\u63a5"):a==Strophe.Status.DISCONNECTED?(window.top.xmpp_connected=!1,LoginXmpp({username:r,userId:t,avatar:u,plainpassword:x}),console.log("\u8fde\u63a5\u5df2\u7ec8\u6b62")):a==Strophe.Status.AUTHFAIL?(console.log("\u8eab\u4efd\u9a8c\u8bc1\u5931\u8d25"),window.top.layer.close(window.top.BOSH_SERVICE_INDEX),h.msg("\u8eab\u4efd\u9a8c\u8bc1\u5931\u8d25",{icon:2,time:1500})):a==Strophe.Status.CONNECTED&&(window.top.xmpp_connected=!0,v&&setTimeout(function(){parent.layer.close(window.top.BOSH_SERVICE_INDEX);$("#p_myIframe",parent.document).show(function(){h.msg("\u606d\u559c\u4f60,\u94fe\u63a5\u6210\u529f",{icon:1,time:1500})}).find("#myIframe").addClass("layui-anim-up layui-anim")},3E3),A++,m.addHandler(q,null,"message",null,null,null),m.send($pres().tree()))}function q(a){var b=a.getElementsByTagName("body");if(0!=b.length){var c=a.getAttribute("from").split("@")[0],l=a.getAttribute("to").split("@")[0],d=b[0].getAttribute("from_Avatar"),g=b[0].getAttribute("to_Avatar");a=b[0].getAttribute("userTemlteEl");var f=b[0].getAttribute("msgId"),c={me:{username:l,content:"",Avatar:g},to:{username:c,content:$(b[0]).text(),Avatar:d},from:"to",userTemlteEl:a,msgId:f};k.msgControlCenter(c,void 0,void 0,!1,a,!0);"none"==$("#p_myIframe",parent.document).css("display")&&(b=$(b[0]).text(),/face\[([^\s\[\]]+?)\]/g.test(b)&&(b=b.replace(/face/g,"\u8868\u60c5")),/img\[([^\s]+?)\]/g.test(b)&&(b="\u60a8\u6709\u65b0\u7684\u56fe\u7247\u6d88\u606f\uff0c\u8bf7\u6ce8\u610f\u67e5\u770b\uff01"),$("#notification",parent.document).show().text(b).attr("data-class",c.userTemlteEl),$("#ChatMsgPrompt",parent.document).addClass("layui-anim-scaleSpring chat-anim layui-anim-loop layui-anim"))}return!0}function e(){return new Promise(function(a){$.ajax({type:"post",url:window.Request_url+"Login/visitor",async:!0,success:function(b){b.dataList.avatar=b.dataList.picture;b.dataList.userId=b.dataList.username;delete b.dataList.picture;LoginXmpp(b.dataList).then(function(){a()})}})})}var h=layui.layer,k=null,B=+new Date,p={},v=null,m=null;window.top.xmpp_connected=!1;window.top.BOSH_SERVICE_INDEX=null;var r="",t="",u="",x="",w=0,y=null,A=1;new X2JS;window.LoginXmpp=function(a){isNaN(a.avatar)&&console.log("\u6ca1\u6709\u5934\u50cf");$(".headImg\x3eimg").attr("src","img/peoples/people"+a.avatar+".png");$(".user_title_name").text(a.name);return new Promise(function(b){r=a.username;t=a.userId;u=a.avatar;x=a.plainpassword;m=new Strophe.Connection(window.top.BOSH_SERVICE);m.connect(a.username+window.suffixPath+"/web"+B,a.plainpassword,n);b()})};var g=function(a){this.bandEv();this.mouse=0;this.x2js=new X2JS};g.prototype.getContextPath=function(){return location.protocol+"//"+location.host+"/"};g.getCookieValue=function(a){for(var b=document.cookie.split(";"),c=0;c<b.length;c++){var l=b[c].split("\x3d");if(l[0].replace(/(^\s*)|(\s*$)/g,"")==a)return l[1]}return""};g.prototype.getPosition=function(a){var b=0;if(document.selection)b=document.selection.createRange(),b.moveStart("character",-a.value.length),b=b.text.length;else if(a.selectionStart||"0"==a.selectionStart)b=a.selectionStart;return this.mouse=b};g.prototype.WriteAndReadChatHistory=function(a){if(window.localStorage){var b=localStorage.getItem("hhyangHistory"),b=null===b?{root:{}}:JSON.parse(b);if(void 0==a)return b;var c=a.userTemlteEl;void 0==b.root[c]&&(b.root[c]=[]);for(var l=0;l<b.root[c].length;l++)if(b.root[c][l].msgId==a.msgId)return!1;b.root[c].push(a);localStorage.setItem("hhyangHistory",JSON.stringify(b))}};g.prototype.msgControlCenter=function(a,b,c,l,d,g){l=void 0===l?!1:l;var f='\x3cli class\x3d"clearfix"\x3e';void 0==a&&(a=$("#conLeft .bg"),a={me:{username:r,userId:t,content:"",Avatar:u},to:{username:$.trim(a.find(".intername").attr("data-name")),userId:a.attr("data-userid"),content:"",Avatar:a.attr("data-avatar")},from:b,msgId:+new Date},a[b].content=c);f="me"==a.from?f+('\x3cimg src\x3d"img/peoples/people'+a.me.Avatar+'.png" class\x3d"answers_head"\x3e\x3cdiv class\x3d"answers"\x3e'):f+('\x3cimg src\x3d"img/peoples/people'+a.to.Avatar+'.png" class\x3d"news_head"\x3e\x3cdiv class\x3d"news"\x3e');f+=textChange(a[a.from].content+"")+"\x3c/div\x3e\x3c/li\x3e";$("."+d).append(f);f=$("."+d)[0].scrollHeight;a.userTemlteEl=d;g&&this.WriteAndReadChatHistory(a);void 0!=b?(b=$msg({to:""+a.to.username+window.suffixPath,from:""+a.me.username+window.suffixPath,type:"chat"}).c("body",{from_Avatar:a.me.Avatar,to_Avatar:a.to.Avatar,userTemlteEl:"hhyangUser"+r,toUserId:t,msgId:a.msgId},c),m.send(b.tree())):l||this.unreadMsgNotice(d);$("#RightCont").scrollTop(f);return!0};g.prototype.unreadMsgNotice=function(a){a=$(".user[data-class\x3d"+a+"]");if(!a.hasClass("bg")){a.find(".liLeft").addClass("moreMsg");var b=a.parents("dd");b.hasClass("active")||(b.addClass("tab-cont active layui-anim-upbit layui-anim"),b.prev().find(".tab-title").addClass("active"),$("#conLeft").scrollTop(a.offset().top-220))}$("#pAudio").html('\x3caudio autoplay id\x3d"audio" src\x3d"'+this.getContextPath()+'newChat/mp3/default.mp3"\x3e\x3c/audio\x3e')};g.prototype.createTemplte=function(a){var b={cs:{name:"\u5728\u7ebf\u5ba2\u670d"},sub:{name:"\u6211\u7684\u4e0b\u7ea7"},"super":{name:"\u6211\u7684\u4e0a\u7ea7"}};p.status={};var c="",g="",d;for(d in a)if(0!=a[d].length){a[d].name=b[d].name;a[d].online=0;a[d].Total=a[d].length;for(var e=0;e<a[d].length;e++){if("cs"==d){var f=parseInt(Math.random()*window.csInfoNames.length);a[d][e].fakeName=window.csInfoNames[f];window.csInfoNames.splice(f,1)}"on"==a[d][e].status&&(f=a[d][e],a[d].splice(e,1),a[d].unshift(f),a[d].online++);f=[];f.push(d);f.push(e);p.status[""+a[d][e].id]=f}for(var e="",f='\x3cdiv class\x3d"tab-div"\x3e\x3cdl\x3e\x3cdt\x3e\x3cdiv class\x3d"tab-title"\x3e\x3cspan class\x3d"tabicon"\x3e\x3c/span\x3e',f=f+('\x3cspan class\x3d"tabName"\x3e'+a[d].name+"\x3c/span\x3e"),f="cs"==d?f+'\x3cspan class\x3d"tabpop" style\x3d"display:none"\x3e':f+'\x3cspan class\x3d"tabpop"\x3e',f=f+('\x3cspan class\x3d"online"\x3e'+a[d].online+'\x3c/span\x3e/\x3cspan class\x3d"leave"\x3e'+a[d].Total+"\x3c/span\x3e"),f=f+'\x3c/span\x3e\x3c/div\x3e\x3c/dt\x3e\x3cdd class\x3d"tab-cont"\x3e\x3cul\x3e',h=0;h<a[d].length;h++){var k=a[d][h],m=k.name,n=m;"cs"==d&&(m=k.fakeName);e+='\x3cul class\x3d"newsList hhyangUser'+n+'"\x3e\x3c/ul\x3e';f+='\x3cli  class\x3d"user" data-class\x3d"hhyangUser'+n+'" data-avatar\x3d"'+k.avatar+'" data-userid\x3d"'+k.id+'"\x3e';f+='\x3cdiv class\x3d"liLeft '+k.status+'"\x3e\x3cimg src\x3d"img/peoples/people'+k.avatar+'.png"\x3e\x3c/div\x3e';f+='\x3cdiv class\x3d"liRight"\x3e\x3cspan class\x3d"intername" data-name\x3d"'+n+'"\x3e'+m+"\x3c/span\x3e";f+='\x3cspan class\x3d"infor"\x3e\x3c/span\x3e\x3c/div\x3e\x3c/li\x3e'}f+="\x3c/ul\x3e\x3c/dd\x3e\x3c/dl\x3e\x3c/div\x3e";c+=e;g+=f}$("#RightCont").html(c);$("#conLeft").html(g);this.showTemplte()};g.prototype.showTemplte=function(a,b){if(void 0==b){var c=$(void 0===a?".tab-title:eq(0)":a).addClass("active").parents(".tab-div");c.find(".tab-cont").addClass("active layui-anim-upbit layui-anim");c=c.find(".user").eq(0).addClass("bg").attr("data-class");$("#RightCont .newsList").removeClass("active layui-anim-upbit layui-anim");$("#RightCont ."+c).addClass("active").html("");this.showHistory(c)}};g.prototype.changeStatus=function(a){try{var b=p.status[a.user.id];p.list[b[0]].splice(b[1],1,a.user);var c=$('.user[data-class\x3d"hhyangUser'+a.user.name+'"]');c.find(".liLeft").removeClass("off on").addClass(a.user.status);var e=c.clone();c.parent().prepend(e);var d=c.parents(".tab-div");c.remove();d.find(".online").text(d.find(".on").length)}catch(C){}};g.prototype.showHistory=function(a){var b=this.WriteAndReadChatHistory().root[a];if(void 0!=b){for(var c=0;c<b.length;c++)this.msgControlCenter(b[c],void 0,void 0,!0,a,!1);a=$("#RightCont ."+a)[0].scrollHeight;$("#RightCont").scrollTop(a)}};g.prototype.uploadImage=function(a){var b=this;$.ajax({type:"post",url:window.Request_url+"Login/upload_images",async:!0,processData:!1,contentType:!1,data:a,success:function(a){var c=window.top.getContextPath();b.msgControlCenter(void 0,"me","img["+c+a.dataList+"]",!1,$(".bg").attr("data-class"),!0);h.closeAll()},error:function(a){h.closeAll();console.log("\u4e0a\u4f20\u56fe\u7247\u5931\u8d25")}})};g.prototype.sendFreqlimit=function(){var a=+new Date;if(0!=w&&3E3>a-w)return y=h.msg("\u60a8\u53d1\u9001\u7684\u9891\u7387\u592a\u5feb\u4e86",{icon:7,time:1500}),!1;h.close(y);w=a;return!0};g.prototype.bandEv=function(){var a=this;$("html").on("click",".layui-layim-photos",function(a){var b=$(a.currentTarget).parents(".newsList"),e=$(a.currentTarget).attr("src"),d={title:"",id:123,start:0,data:[]};b.find(".layui-layim-photos").each(function(a,b){var c=$(b).attr("src");c==e&&d.start.index;d.data.push({alt:"",pid:a,src:c,thumb:""})});window.top.$hhyangUtil.showPhotos(d)});$("html").on("click",".tab-title",function(a){$(a.currentTarget).toggleClass("active");$(a.currentTarget).parents(".tab-div").find(".tab-cont").toggleClass("active layui-anim-upbit layui-anim")});$("#layim-face li").on("click",function(b){var c="face"+$(b.currentTarget).attr("title"),e=$("#dope").val().split("");e.splice(a.mouse,0,c);$("#dope").val(e.join("")).click();b.stopPropagation()});$("#dope").on("input",function(b){a.getPosition(b.currentTarget)});$("#dope").on("click",function(b){a.getPosition(b.currentTarget)});$("html").on("click",".user",function(b){$(b.currentTarget).find(".liLeft").removeClass("moreMsg");$(".user").removeClass("bg");b=$(b.currentTarget).addClass("bg").attr("data-class");$("#RightCont .newsList").removeClass("active");$("#RightCont ."+b).addClass("active").html("");a.showHistory(b)});$("html").on("click","#sendBtn",function(){if(""==$.trim($("#dope").val())||!a.sendFreqlimit())return!1;var b=$(".bg").attr("data-class");a.msgControlCenter(void 0,"me",$("#dope").val(),!1,b,!0);$("#dope").val("")});$("html").keydown(function(a){13==a.keyCode&&""!=$.trim($("#dope").val())&&($("#sendBtn").trigger("click"),a.stopPropagation(),a.preventDefault())});$("html").on("change","#files",function(b){h.msg("\u6b63\u5728\u5904\u7406,\u8bf7\u7a0d\u540e",{icon:16,time:!1,shade:[.1,"transparent"]});var c=new FormData;c.append("upload",$(b.currentTarget)[0].files[0]);$(b.currentTarget).remove();$("#files_li").append('\x3cinput type\x3d"file" id\x3d"files" name\x3d"files" accept\x3d"image/png,image/jpeg,image/gif"/\x3e');if(!a.sendFreqlimit())return!1;a.uploadImage(c)});$("#face").click(function(a){$("#emjon").show().addClass("layui-anim-scale layui-anim");setTimeout(function(){$("#emjon").removeClass("layui-anim-scale layui-anim")},300);a.stopPropagation()});$("body").on("click",function(a){"block"==$("#emjon").css("display")&&$("#emjon").hide()})};var z=window.top.initChat=function(a){a=void 0===a?!1:a;return new Promise(function(b){a?(v=!0,e().then(function(){b()})):(v=!1,LoginXmpp({username:g.getCookieValue("userName"),name:g.getCookieValue("userName"),plainpassword:g.getCookieValue("chat_pwd"),userId:g.getCookieValue("userId"),avatar:g.getCookieValue("avatar")}).then(function(){b()}))})};""!=g.getCookieValue("code_token")&&z();$("html").on("click","#close",function(a){$("#p_myIframe",window.parent.document).hide()});$("body",parent.document).on("click","#notification",function(a){a=$(a.currentTarget).hide().attr("data-class");a=$(".user[data-class\x3d"+a+"]");var b=a.parents(".tab-div");$("#p_myIframe",window.parent.document).show();$("#ChatMsgPrompt",parent.document).removeClass("layui-anim-scaleSpring chat-anim layui-anim-loop layui-anim");a.click();b.click();a=b.siblings();a.find(".tab-title.active").removeClass("active");a.find(".tab-cont.active.layui-anim-upbit.layui-anim").removeClass("active layui-anim-upbit layui-anim")});$("body",parent.document).on("click",".showChat",function(){$("#ChatMsgPrompt",parent.document).removeClass("layui-anim-scaleSpring chat-anim layui-anim-loop layui-anim");window.top.BOSH_SERVICE_INDEX=parent.layer.msg("\u6b63\u5728\u4e3a\u60a8\u63a5\u5165\u5ba2\u670d,\u8bf7\u7a0d\u540e...",{icon:16,time:!1,shade:[.6,"#000"]});window.top.xmpp_connected?(parent.layer.close(window.top.BOSH_SERVICE_INDEX),$("#p_myIframe",window.parent.document).show(),h.msg("\u5ba2\u670d\u63a5\u5165\u6210\u529f!",{icon:1,time:1500})):""==g.getCookieValue("code_token")&&z(!0)})});