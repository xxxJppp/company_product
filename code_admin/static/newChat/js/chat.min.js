var faces=function(m){return"img/face/"+"[\u5fae\u7b11] [\u563b\u563b] [\u54c8\u54c8] [\u53ef\u7231] [\u53ef\u601c] [\u6316\u9f3b] [\u5403\u60ca] [\u5bb3\u7f9e] [\u6324\u773c] [\u95ed\u5634] [\u9119\u89c6] [\u7231\u4f60] [\u6cea] [\u5077\u7b11] [\u4eb2\u4eb2] [\u751f\u75c5] [\u592a\u5f00\u5fc3] [\u767d\u773c] [\u53f3\u54fc\u54fc] [\u5de6\u54fc\u54fc] [\u5618] [\u8870] [\u59d4\u5c48] [\u5410] [\u54c8\u6b20] [\u62b1\u62b1] [\u6012] [\u7591\u95ee] [\u998b\u5634] [\u62dc\u62dc] [\u601d\u8003] [\u6c57] [\u56f0] [\u7761] [\u94b1] [\u5931\u671b] [\u9177] [\u8272] [\u54fc] [\u9f13\u638c] [\u6655] [\u60b2\u4f24] [\u6293\u72c2] [\u9ed1\u7ebf] [\u9634\u9669] [\u6012\u9a82] [\u4e92\u7c89] [\u5fc3] [\u4f24\u5fc3] [\u732a\u5934] [\u718a\u732b] [\u5154\u5b50] [ok] [\u8036] [good] [NO] [\u8d5e] [\u6765] [\u5f31] [\u8349\u6ce5\u9a6c] [\u795e\u9a6c] [\u56e7] [\u6d6e\u4e91] [\u7ed9\u529b] [\u56f4\u89c2] [\u5a01\u6b66] [\u5965\u7279\u66fc] [\u793c\u7269] [\u949f] [\u8bdd\u7b52] [\u8721\u70db] [\u86cb\u7cd5]".split(" ").indexOf(m)+".gif"},textChange=function(m){var p=function(g){return new RegExp("\\n*\\["+(g||"")+"(code|pre|div|span|p|table|thead|th|tbody|tr|td|ul|li|ol|li|dl|dt|dd|h2|h3|h4|h5)([\\s\\S]*?)\\]\\n*","g")};return(m||"").replace(/&(?!#?[a-zA-Z0-9]+;)/g,"\x26amp;").replace(/</g,"\x26lt;").replace(/>/g,"\x26gt;").replace(/'/g,"\x26#39;").replace(/"/g,"\x26quot;").replace(/@(\S+)(\s+?|$)/g,'@\x3ca href\x3d"javascript:;"\x3e$1\x3c/a\x3e$2').replace(/face\[([^\s\[\]]+?)\]/g,function(g){g=g.replace(/^face/g,"");return'\x3cimg alt\x3d"'+g+'" title\x3d"'+g+'" src\x3d"'+faces(g)+'"\x3e'}).replace(/img\[([^\s]+?)\]/g,function(g){g=g.replace(/(^img\[)|(\]$)/g,"");return'\x3cimg class\x3d"layui-layim-photos" src\x3d"'+g+'" layer-src\x3d"'+g+'"\x3e'}).replace(/a\([\s\S]+?\)\[[\s\S]*?\]/g,function(g){var h=(g.match(/a\(([\s\S]+?)\)\[/)||[])[1],k=(g.match(/\)\[([\s\S]*?)\]/)||[])[1];return h?'\x3ca href\x3d"'+h+'" target\x3d"_blank"\x3e'+(k||h)+"\x3c/a\x3e":g}).replace(p(),"\x3c$1 $2\x3e").replace(p("/"),"\x3c/$1\x3e").replace(/\n/g,"\x3cbr\x3e")};layui.use("layer",function(){function m(a){l.xmlInput=function(a){$.nodeName(a,"iq")&&1==$(a).children().length&&$.nodeName($(a).children().eq(0)[0],"body")&&"lottery"==$(a).children().eq(0)[0].getAttribute("xmlns")&&(a=JSON.parse($(a).children().eq(0).text()),1==a.type?(n=a,null===k&&(k=new c(window),k.createTemplte(n.list))):2==a.type&&k.changeStatus(a))};a==Strophe.Status.ERROR?console.log("\u51fa\u73b0\u9519\u8bef"):a==Strophe.Status.CONNECTING?console.log("\u6b63\u5728\u94fe\u63a5"):a==Strophe.Status.CONNFAIL?console.log("\u8fde\u63a5\u5c1d\u8bd5\u5931\u8d25"):a==Strophe.Status.DISCONNECTING?console.log("\u5f53\u524d\u6b63\u5728\u7ec8\u6b62\u8fde\u63a5"):a==Strophe.Status.DISCONNECTED?(window.top.xmpp_connected=!1,LoginXmpp({username:q,userId:r,avatar:t,plainpassword:w}),console.log("\u8fde\u63a5\u5df2\u7ec8\u6b62")):a==Strophe.Status.AUTHFAIL?(console.log("\u8eab\u4efd\u9a8c\u8bc1\u5931\u8d25"),window.top.layer.close(window.top.BOSH_SERVICE_INDEX),h.msg("\u8eab\u4efd\u9a8c\u8bc1\u5931\u8d25",{icon:2,time:1500})):a==Strophe.Status.CONNECTED&&(window.top.xmpp_connected=!0,u&&setTimeout(function(){parent.layer.close(window.top.BOSH_SERVICE_INDEX);$("#p_myIframe",parent.document).show(function(){h.msg("\u606d\u559c\u4f60,\u94fe\u63a5\u6210\u529f",{icon:1,time:1500})}).find("#myIframe").addClass("layui-anim-up layui-anim")},3E3),z++,l.addHandler(p,null,"message",null,null,null),l.send($pres().tree()))}function p(a){var b=a.getElementsByTagName("body");if(0!=b.length){var d=a.getAttribute("from").split("@")[0],A=a.getAttribute("to").split("@")[0],e=b[0].getAttribute("from_Avatar"),c=b[0].getAttribute("to_Avatar");a=b[0].getAttribute("userTemlteEl");var f=b[0].getAttribute("msgId"),d={me:{username:A,content:"",Avatar:c},to:{username:d,content:$(b[0]).text(),Avatar:e},from:"to",userTemlteEl:a,msgId:f};k.msgControlCenter(d,void 0,void 0,!1,a,!0);"none"==$("#p_myIframe",parent.document).css("display")&&(b=$(b[0]).text(),/face\[([^\s\[\]]+?)\]/g.test(b)&&(b=b.replace(/face/g,"\u8868\u60c5")),/img\[([^\s]+?)\]/g.test(b)&&(b="\u60a8\u6709\u65b0\u7684\u56fe\u7247\u6d88\u606f\uff0c\u8bf7\u6ce8\u610f\u67e5\u770b\uff01"),$("#notification",parent.document).show().text(b).attr("data-class",d.userTemlteEl),$("#ChatMsgPrompt",parent.document).addClass("layui-anim-scaleSpring chat-anim layui-anim-loop layui-anim"))}return!0}function g(){return new Promise(function(a){$.ajax({type:"post",url:window.location_url+"Login/visitor",async:!0,success:function(b){b.dataList.avatar=b.dataList.picture;b.dataList.userId=b.dataList.username;delete b.dataList.picture;LoginXmpp(b.dataList).then(function(){a()})}})})}var h=layui.layer,k=null,B=+new Date,n={},u=null,l=null;window.top.xmpp_connected=!1;window.top.BOSH_SERVICE_INDEX=null;var q="",r="",t="",w="",v=0,x=null,z=1;new X2JS;window.LoginXmpp=function(a){isNaN(a.avatar)&&console.log("\u6ca1\u6709\u5934\u50cf");$(".headImg\x3eimg").attr("src","img/peoples/people"+a.avatar+".png");$(".user_title_name").text(a.name);return new Promise(function(b){q=a.username;r=a.userId;t=a.avatar;w=a.plainpassword;l=new Strophe.Connection(window.top.BOSH_SERVICE);l.connect(a.username+window.suffixPath+"/web"+B,a.plainpassword,m);b()})};var c=function(a){this.bandEv();this.mouse=0;this.x2js=new X2JS};c.prototype.getContextPath=function(){return location.protocol+"//"+location.host+"/"};c.getCookieValue=function(a){for(var b=document.cookie.split(";"),d=0;d<b.length;d++){var c=b[d].split("\x3d");if(c[0].replace(/(^\s*)|(\s*$)/g,"")==a)return c[1]}return""};c.prototype.getPosition=function(a){var b=0;if(document.selection)b=document.selection.createRange(),b.moveStart("character",-a.value.length),b=b.text.length;else if(a.selectionStart||"0"==a.selectionStart)b=a.selectionStart;return this.mouse=b};c.prototype.WriteAndReadChatHistory=function(a){if(window.localStorage){var b=localStorage.getItem("hhyangHistory"),b=null===b?{root:{}}:JSON.parse(b);if(void 0==a)return b;var d=a.userTemlteEl;void 0==b.root[d]&&(b.root[d]=[]);for(var c=0;c<b.root[d].length;c++)if(b.root[d][c].msgId==a.msgId)return!1;b.root[d].push(a);localStorage.setItem("hhyangHistory",JSON.stringify(b))}};c.prototype.msgControlCenter=function(a,b,d,c,e,g){c=void 0===c?!1:c;var f='\x3cli class\x3d"clearfix"\x3e';void 0==a&&(a=$("#conLeft .bg"),a={me:{username:q,userId:r,content:"",Avatar:t},to:{username:$.trim(a.find(".intername").attr("data-name")),userId:a.attr("data-userid"),content:"",Avatar:a.attr("data-avatar")},from:b,msgId:+new Date},a[b].content=d);f="me"==a.from?f+('\x3cimg src\x3d"img/peoples/people'+a.me.Avatar+'.png" class\x3d"answers_head"\x3e\x3cdiv class\x3d"answers"\x3e'):f+('\x3cimg src\x3d"img/peoples/people'+a.to.Avatar+'.png" class\x3d"news_head"\x3e\x3cdiv class\x3d"news"\x3e');f+=textChange(a[a.from].content+"")+"\x3c/div\x3e\x3c/li\x3e";$("."+e).append(f);f=$("."+e)[0].scrollHeight;a.userTemlteEl=e;g&&this.WriteAndReadChatHistory(a);void 0!=b?(b=$msg({to:""+a.to.username+window.suffixPath,from:""+a.me.username+window.suffixPath,type:"chat"}).c("body",{from_Avatar:a.me.Avatar,to_Avatar:a.to.Avatar,userTemlteEl:"hhyangUser"+q,toUserId:r,msgId:a.msgId},d),l.send(b.tree())):c||this.unreadMsgNotice(e);$("#RightCont").scrollTop(f);return!0};c.prototype.unreadMsgNotice=function(a){a=$(".user[data-class\x3d"+a+"]");if(!a.hasClass("bg")){a.find(".liLeft").addClass("moreMsg");var b=a.parents("dd");b.hasClass("active")||(b.addClass("tab-cont active layui-anim-upbit layui-anim"),b.prev().find(".tab-title").addClass("active"),$("#conLeft").scrollTop(a.offset().top-220))}$("#pAudio").html('\x3caudio autoplay id\x3d"audio" src\x3d"'+this.getContextPath()+'/static/newChat/mp3/default.mp3"\x3e\x3c/audio\x3e')};c.prototype.createTemplte=function(a){var b={cs:{name:"\u5728\u7ebf\u5ba2\u670d"},sub:{name:"\u6211\u7684\u4e0b\u7ea7"},"super":{name:"\u6211\u7684\u4e0a\u7ea7"}};n.status={};var d="",c="",e;for(e in a)if(0!=a[e].length){a[e].name=b[e].name;a[e].online=0;a[e].Total=a[e].length;for(var g=0;g<a[e].length;g++){if("cs"==e){var f=parseInt(Math.random()*window.csInfoNames.length);a[e][g].fakeName=window.csInfoNames[f];window.csInfoNames.splice(f,1)}"on"==a[e][g].status&&(f=a[e][g],a[e].splice(g,1),a[e].unshift(f),a[e].online++);f=[];f.push(e);f.push(g);n.status[""+a[e][g].id]=f}for(var g="",f='\x3cdiv class\x3d"tab-div"\x3e\x3cdl\x3e\x3cdt\x3e\x3cdiv class\x3d"tab-title"\x3e\x3cspan class\x3d"tabicon"\x3e\x3c/span\x3e',f=f+('\x3cspan class\x3d"tabName"\x3e'+a[e].name+"\x3c/span\x3e"),f="cs"==e?f+'\x3cspan class\x3d"tabpop" style\x3d"display:none"\x3e':f+'\x3cspan class\x3d"tabpop"\x3e',f=f+('\x3cspan class\x3d"online"\x3e'+a[e].online+'\x3c/span\x3e/\x3cspan class\x3d"leave"\x3e'+a[e].Total+"\x3c/span\x3e"),f=f+'\x3c/span\x3e\x3c/div\x3e\x3c/dt\x3e\x3cdd class\x3d"tab-cont"\x3e\x3cul\x3e',h=0;h<a[e].length;h++){var k=a[e][h],l=k.name,m=l;"cs"==e&&(l=k.fakeName);g+='\x3cul class\x3d"newsList hhyangUser'+m+'"\x3e\x3c/ul\x3e';f+='\x3cli  class\x3d"user" data-class\x3d"hhyangUser'+m+'" data-avatar\x3d"'+k.avatar+'" data-userid\x3d"'+k.id+'"\x3e';f+='\x3cdiv class\x3d"liLeft '+k.status+'"\x3e\x3cimg src\x3d"img/peoples/people'+k.avatar+'.png"\x3e\x3c/div\x3e';f+='\x3cdiv class\x3d"liRight"\x3e\x3cspan class\x3d"intername" data-name\x3d"'+m+'"\x3e'+l+"\x3c/span\x3e";f+='\x3cspan class\x3d"infor"\x3e\x3c/span\x3e\x3c/div\x3e\x3c/li\x3e'}f+="\x3c/ul\x3e\x3c/dd\x3e\x3c/dl\x3e\x3c/div\x3e";d+=g;c+=f}$("#RightCont").html(d);$("#conLeft").html(c);this.showTemplte()};c.prototype.showTemplte=function(a,b){if(void 0==b){var d=$(void 0===a?".tab-title:eq(0)":a).addClass("active").parents(".tab-div");d.find(".tab-cont").addClass("active layui-anim-upbit layui-anim");d=d.find(".user").eq(0).addClass("bg").attr("data-class");$("#RightCont .newsList").removeClass("active layui-anim-upbit layui-anim");$("#RightCont ."+d).addClass("active").html("");this.showHistory(d)}};c.prototype.changeStatus=function(a){try{var b=n.status[a.user.id];n.list[b[0]].splice(b[1],1,a.user);var d=$('.user[data-class\x3d"hhyangUser'+a.user.name+'"]');d.find(".liLeft").removeClass("off on").addClass(a.user.status);var c=d.clone();d.parent().prepend(c);var e=d.parents(".tab-div");d.remove();e.find(".online").text(e.find(".on").length)}catch(C){}};c.prototype.showHistory=function(a){var b=this.WriteAndReadChatHistory().root[a];if(void 0!=b){for(var d=0;d<b.length;d++)this.msgControlCenter(b[d],void 0,void 0,!0,a,!1);a=$("#RightCont ."+a)[0].scrollHeight;$("#RightCont").scrollTop(a)}};c.prototype.uploadImage=function(a){var b=this;$.ajax({type:"post",url:window.location_url+"Login/upload_images",async:!0,processData:!1,contentType:!1,data:a,success:function(a){window.top.getContextPath();b.msgControlCenter(void 0,"me","img["+Request_url+a.dataList+"]",!1,$(".bg").attr("data-class"),!0);h.closeAll()},error:function(a){h.closeAll();console.log("\u4e0a\u4f20\u56fe\u7247\u5931\u8d25")}})};c.prototype.sendFreqlimit=function(){var a=+new Date;if(0!=v&&3E3>a-v)return x=h.msg("\u60a8\u53d1\u9001\u7684\u9891\u7387\u592a\u5feb\u4e86",{icon:7,time:1500}),!1;h.close(x);v=a;return!0};c.prototype.bandEv=function(){var a=this;$("html").on("click",".layui-layim-photos",function(a){var b=$(a.currentTarget).parents(".newsList"),c=$(a.currentTarget).attr("src"),e={title:"",id:123,start:0,data:[]};b.find(".layui-layim-photos").each(function(a,b){var d=$(b).attr("src");d==c&&e.start.index;e.data.push({alt:"",pid:a,src:d,thumb:""})});window.top.$hhyangUtil.showPhotos(e)});$("html").on("click",".tab-title",function(a){$(a.currentTarget).toggleClass("active");$(a.currentTarget).parents(".tab-div").find(".tab-cont").toggleClass("active layui-anim-upbit layui-anim")});$("#layim-face li").on("click",function(b){var d="face"+$(b.currentTarget).attr("title"),c=$("#dope").val().split("");c.splice(a.mouse,0,d);$("#dope").val(c.join("")).click();b.stopPropagation()});$("#dope").on("input",function(b){a.getPosition(b.currentTarget)});$("#dope").on("click",function(b){a.getPosition(b.currentTarget)});$("html").on("click",".user",function(b){$(b.currentTarget).find(".liLeft").removeClass("moreMsg");$(".user").removeClass("bg");b=$(b.currentTarget).addClass("bg").attr("data-class");$("#RightCont .newsList").removeClass("active");$("#RightCont ."+b).addClass("active").html("");a.showHistory(b)});$("html").on("click","#sendBtn",function(){if(""==$.trim($("#dope").val())||!a.sendFreqlimit())return!1;var b=$(".bg").attr("data-class");a.msgControlCenter(void 0,"me",$("#dope").val(),!1,b,!0);$("#dope").val("")});$("html").keydown(function(a){13==a.keyCode&&""!=$.trim($("#dope").val())&&($("#sendBtn").trigger("click"),a.stopPropagation(),a.preventDefault())});$("html").on("change","#files",function(b){h.msg("\u6b63\u5728\u5904\u7406,\u8bf7\u7a0d\u540e",{icon:16,time:!1,shade:[.1,"transparent"]});var c=new FormData;c.append("upload",$(b.currentTarget)[0].files[0]);$(b.currentTarget).remove();$("#files_li").append('\x3cinput type\x3d"file" id\x3d"files" name\x3d"files" accept\x3d"image/png,image/jpeg,image/gif"/\x3e');if(!a.sendFreqlimit())return!1;a.uploadImage(c)});$("#face").click(function(a){$("#emjon").show().addClass("layui-anim-scale layui-anim");setTimeout(function(){$("#emjon").removeClass("layui-anim-scale layui-anim")},300);a.stopPropagation()});$("body").on("click",function(a){"block"==$("#emjon").css("display")&&$("#emjon").hide()})};var y=window.top.initChat=function(a){a=void 0===a?!1:a;return new Promise(function(b){a?(u=!0,g().then(function(){b()})):(u=!1,LoginXmpp({username:c.getCookieValue("userName"),name:c.getCookieValue("show_Name"),plainpassword:c.getCookieValue("chat_pwd"),userId:c.getCookieValue("userId"),avatar:c.getCookieValue("avatar")}).then(function(){b()}))})};""!=c.getCookieValue("code_token")&&y();$("html").on("click","#close",function(a){$("#p_myIframe",window.parent.document).hide()});$("body",parent.document).on("click","#notification",function(a){a=$(a.currentTarget).hide().attr("data-class");a=$(".user[data-class\x3d"+a+"]");var b=a.parents(".tab-div");$("#p_myIframe",window.parent.document).show();$("#ChatMsgPrompt",parent.document).removeClass("layui-anim-scaleSpring chat-anim layui-anim-loop layui-anim");a.click();b.click();a=b.siblings();a.find(".tab-title.active").removeClass("active");a.find(".tab-cont.active.layui-anim-upbit.layui-anim").removeClass("active layui-anim-upbit layui-anim")});$("body",parent.document).on("click",".showChat",function(){$("#ChatMsgPrompt",parent.document).removeClass("layui-anim-scaleSpring chat-anim layui-anim-loop layui-anim");window.top.BOSH_SERVICE_INDEX=parent.layer.msg("\u6b63\u5728\u4e3a\u60a8\u63a5\u5165\u5ba2\u670d,\u8bf7\u7a0d\u540e...",{icon:16,time:!1,shade:[.6,"#000"]});window.top.xmpp_connected?(parent.layer.close(window.top.BOSH_SERVICE_INDEX),$("#p_myIframe",window.parent.document).show(),h.msg("\u5ba2\u670d\u63a5\u5165\u6210\u529f!",{icon:1,time:1500})):""==c.getCookieValue("code_token")&&y(!0)})});